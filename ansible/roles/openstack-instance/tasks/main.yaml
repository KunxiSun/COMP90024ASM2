  - name: Create an instance
    os_server:
      name: '{{ item.name }}'
      image: '{{ instance_image }}'
      key_name: '{{ instance_key_name }}'
      flavor: '{{ item.flavor }}'
      availability_zone: '{{ availability_zone }}'
      security_groups: '{{ sg_names }}'
      volumes: '{{ item.volumes }}'
      auto_floating_ip: yes
      wait: yes
      timeout: 600
      state: present
    loop: '{{ instances }}'
    register: os_instance

  - name: Wait for connection
    wait_for:
      host: "{{ item.openstack.public_v4 }}"
      port: 22
      timeout: 120
      search_regex: OpenSSH
    loop: '{{ os_instance.results }}'
    when: item.openstack is defined

  - name: Add hosts
    add_host:
      name: '{{ item.openstack.public_v4 }}'
      groups: cloud
    loop: '{{ os_instance.results }}'
    when: item.openstack is defined

  # - name: Create inventory file
  #   copy:
  #     content: "[all:vars]\nansible_user=ubuntu\n\n[dbServers:children]\ndbMaster\ndbSlave\n\n[dbMaster:children]\ninstance1\n\n[dbSlave:children]\ninstance2\ninstance3\n\n"
  #     dest: "{{project_path}}/ansible/inventory/hosts.ini"

  # - name: Store instance ip in inventory file
  #   lineinfile:
  #     line: "[{{ item.name }}]\n{{ item.openstack.public_v4 }}\n"
  #     dest:  "{{project_path}}/ansible/inventory/hosts.ini"
  #   loop: '{{ os_instance.results }}'
